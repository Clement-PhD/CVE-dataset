BEGIN;

CREATE TABLE urls (
    id SERIAL PRIMARY KEY,
    cve_id UUID NOT NULL,
    url TEXT,
    patch BOOLEAN,
    github_pull_request BOOLEAN,
    FOREIGN KEY (cve_id) REFERENCES cves(id) ON DELETE CASCADE
);

DO $$
DECLARE
    rec RECORD;
    ref JSONB;
    tag TEXT;
    is_patch BOOLEAN;
    is_github_pull_request BOOLEAN;
BEGIN
    FOR rec IN SELECT id, jsonb_array_elements(json->'references') AS ref FROM cves
    LOOP
        is_patch := FALSE;
        is_github_pull_request := rec.ref->>'url' LIKE '%github.com/%/pull/%';

        -- Check if any tag is 'Patch'
        FOR tag IN SELECT jsonb_array_elements_text(rec.ref->'tags')
        LOOP
            IF tag = 'Patch' THEN
                is_patch := TRUE;
                EXIT;
            END IF;
        END LOOP;

        INSERT INTO urls (cve_id, url, patch, github_pull_request)
        VALUES (rec.id, rec.ref->>'url', is_patch, is_github_pull_request);
    END LOOP;
END $$;

COMMIT;