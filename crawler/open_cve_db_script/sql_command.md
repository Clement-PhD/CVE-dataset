# SQL commands
Using pgadmin, to execute a sql command, see [here](https://support.spiresystems.com/support/solutions/articles/13000015301-executing-a-sql-query-using-pgadmin).

## see all the table


```sql
SELECT tablename FROM pg_catalog.pg_tables WHERE schemaname != 'pg_catalog' AND schemaname != 'information_schema';
```
![all the tables](img/all_tables_cve.png)

## the cve records

```sql
SELECT * FROM cves LIMIT 100;
```

## get all the cve with a pull request (patch)

See [here](/json_field_exemple.json) to have an exemple of json inside the cve

```sql
SELECT * FROM cves
WHERE EXISTS (
    SELECT 1
    FROM jsonb_array_elements(json->'references') AS ref
    WHERE ref->>'url' LIKE '%github.com/%/pull/%'
)
LIMIT 100;
```

Select all cve with a patch as pull request github

```sql
SELECT * FROM cves
WHERE EXISTS (
    SELECT 1
    FROM jsonb_array_elements(json->'references') AS ref
    WHERE ref->>'url' LIKE '%github.com/%/pull/%'
      AND EXISTS (
          SELECT 1 
          FROM jsonb_array_elements_text(ref->'tags') AS tag
          WHERE tag = 'Patch'
      )
)

ORDER BY cves.cve_id DESC LIMIT 100;

```

Make the database only on that `cat keep_github_pull_request_patch_cve.sql | docker exec -i [uid] psql -U opencve -d opencve`.

> WARN : need to update the constraint first with `/update_constraints.sql`

### Limit only on the crate (Rust filter)

```sql
SELECT * FROM cves
WHERE summary LIKE '%crate%' ORDER BY cves.cve_id DESC LIMIT 100;
```

### Limit only on .c (C filter)

```sql
SELECT * FROM cves
WHERE summary LIKE '%.c %' ORDER BY cves.cve_id DESC LIMIT 100;
```

## Use of the [urls](/add_url_table.sql) table

To optimize the request, we introduce the urls table, which already compute the patch and github pull request. The script to populate the table is [here](/add_url_table.sql). This allow an optimized version of the querry :

```sql
SELECT c.* FROM cves c
JOIN urls u ON c.id = u.cve_id
WHERE u.github_pull_request = TRUE AND u.patch = TRUE;
```