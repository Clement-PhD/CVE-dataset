

from typing import List, Tuple
import psycopg2


class PostgreeConnection:


    HOST = 'localhost'
    PORT = '5432'
    DATABASE = 'opencve'
    USER = 'opencve'
    PASSWORD = 'opencve'

    SQL_QUERY_DOWNLOAD_ONE_URL_PATH = "src/download/get_cve_and_pull_request.sql"
    SQL_QUERY_DOWNLOAD_ALL_URL_PATH = "src/stats/get_cve_and_all_pull_request.sql"

    def __init__(self):
        try:
            self.connection = psycopg2.connect(
                host=PostgreeConnection.HOST,
                port=PostgreeConnection.PORT,
                database=PostgreeConnection.DATABASE,
                user=PostgreeConnection.USER,
                password=PostgreeConnection.PASSWORD
            )
        except psycopg2.DatabaseError as e:
            print(f"Error: {e}")
            exit(1)
    
    def __del__(self):
        self.connection.close()

    def execute_query(self, query : str):
        try:
            # Create a cursor object
            cur = self.connection.cursor()
            
            # Execute a query
            cur.execute(query)

            # Fetch the results (if applicable)
            results = cur.fetchall()

            # Close the cursor
            cur.close()

            return results
        except psycopg2.DatabaseError as e:
            print(f"Error: {e}")
            return None
    

    def get_cve_and_pull_request(self) -> List[Tuple[str, str]]:
        """Get the CVE and the pull request URL from the database"""
        query = ""
        with open(PostgreeConnection.SQL_QUERY_DOWNLOAD_ONE_URL_PATH, "r") as f:
            query = f.read()
        
        results : List[Tuple[str, str]] = self.execute_query(query) # type: ignore # CVE, PULL_REQUEST_URL

        return results
    
    def get_cve_and_all_pull_request(self) -> List[Tuple[str, str]]:
        """Get the CVE and all the pull request URL from the database (separated by a comma)"""
        query = ""
        with open(PostgreeConnection.SQL_QUERY_DOWNLOAD_ALL_URL_PATH, "r") as f:
            query = f.read()
        
        results : List[Tuple[str, str]] = self.execute_query(query) # type: ignore # CVE, PULL_REQUEST_URL

        return results