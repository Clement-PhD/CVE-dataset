@@ -2,23 +2,39 @@
 class login
 {
 	private $database;
-	
+	public $token;
+
 	function __construct ($database)
 	{
 		if (session_id() == "") session_start();
-		
+		if (empty($_SESSION['token'])) {
+			$this->generateXsrfToken();
+		}
+
 		$this->database = $database;
 	}
+
+	function generateXsrfToken() {
+		if (function_exists('mcrypt_create_iv')) {
+			$_SESSION['token'] = bin2hex(mcrypt_create_iv(32, MCRYPT_DEV_URANDOM));
+		} else {
+			$_SESSION['token'] = bin2hex(openssl_random_pseudo_bytes(32));
+		}
+	}
+
+	function xsrfCheck() {
+		if ($_POST['xsrf_token'] !== $_SESSION['token']) {
+			http_response_code(403);
+			throw new Exception("XSRF Token missing or mismatch");
+		}
+	}
 	
 	function isLoggedIn ()
 	{
-		if(isset($_SESSION['userId'], $_SESSION['username'], $_SESSION['level']))
+		if(isset($_SESSION['loggedIn'], $_SESSION['userId'], $_SESSION['username'], $_SESSION['level']))
 		{
-			$query = "SELECT id FROM users WHERE username='".$this->database->escape_string($_SESSION['username'])."' AND
-			password='".$this->database->escape_string($_SESSION['password'])."' AND
-			level='".$this->database->escape_string($_SESSION['level'])."' AND id='".$this->database->escape_string($_SESSION['userId'])."'
-			AND active='1'";
-			$query = $this->database->query_slave($query);
+			$query = "SELECT id FROM users WHERE username=? AND level=? AND id=? AND active='1'";
+			$query = $this->database->query_slave($query, [ $_SESSION['username'], $_SESSION['level'], $_SESSION['userId'] ]);
 			if($this->database->num_rows($query)!=1)
             {
             	throw new Exception ("FakeLoginFound");
@@ -35,26 +51,67 @@ function isLoggedIn ()
 	
 	function login ($username, $password)
 	{
-		$query = "SELECT id, fullname, level, password FROM users WHERE username='".$this->database->escape_string($username)."' AND password='".md5($this->database->escape_string($password))."' AND active='1'";
-		$query = $this->database->query_slave($query);
+		global $u2f;
+		$query = "SELECT id, fullname, level, password, u2fdata FROM users WHERE username=? AND active='1'";
+		$query = $this->database->query_slave($query, [ $username ]);
 		
-		if($this->database->num_rows($query)!=1)
+		$record = $this->database->fetch_row($query);
+		if(!$record || !(password_verify($password, $record['password']) || md5($password) === $record['password']))
 		{
-			throw new Exception ("NoUserFound");
+			throw new Exception ("User not found or inactive or password invalid");
 		}else
 		{
-			$record = $this->database->fetch_array($query);
-			
 			$_SESSION['userId']	= $record['id'];
-			$_SESSION['username']	= $record['fullname'];
+			$_SESSION['fullname']	= $record['fullname'];
 			$_SESSION['level']	= $record['level'];
 			$_SESSION['username']	= $username;
 			$_SESSION['password']	= $record['password'];
-			
-			return true;
+			if ($record['u2fdata'] != NULL) {
+				$u2fdata = json_decode($record['u2fdata']);
+				if ($u2fdata) {
+					//var_dump($u2fdata);
+					$data = $u2f->getAuthenticateData($u2fdata);
+
+					$_SESSION['authReq'] = json_encode($data);
+					return array("status"=>"success","text"=>"Please touch your U2F token...", 'u2f_challenge' => array('challenge'=>$data, 'username'=>$username));
+				}
+			}
+			$_SESSION['loggedIn'] = true;
+			$this->generateXsrfToken();
+
+			return array("status" => "success", "text" => "Welcome, you have been logged in.", "reload" => "yes");
 		}
 	}
-	
+
+	function checkU2fSignature($username, $response) {
+		global $u2f;
+		$authReq = json_decode($_SESSION['authReq']);
+		$_SESSION['authReq'] = NULL;
+		if ($username !== $_SESSION['username']) throw new Exception("InvalidRequest");
+		$query = "SELECT u2fdata FROM users WHERE username=? AND active='1'";
+		$query = $this->database->query_slave($query, [ $username ]);
+
+		if($this->database->num_rows($query)!=1) {
+			throw new Exception ("NoUserFound");
+		}else{
+			$record = $this->database->fetch_row($query);
+			if ($record['u2fdata'] != NULL) {
+				$u2fdata = json_decode($record['u2fdata']);
+				$data = $u2f->doAuthenticate($authReq, $u2fdata, json_decode($response));
+				foreach($u2fdata as &$i) {
+					if ($i->id == $data->id) $i->counter = $data->counter;
+				}
+				$this->database->updateModel('users', [ 'username' => $username ],
+											[ 'u2fdata' => json_encode($u2fdata) ]);
+
+				$_SESSION['loggedIn'] = true;
+				$this->generateXsrfToken();
+				return TRUE;
+			}
+		}
+		throw new Exception("LoginError");
+	}
+
 	function logout ()
 	{
 		if (isset($_COOKIE[session_name()])) {
@@ -64,4 +121,3 @@ function logout ()
 		session_destroy();
 	}
 }
-?>
