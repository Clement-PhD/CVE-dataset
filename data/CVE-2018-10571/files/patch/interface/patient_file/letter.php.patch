@@ -1,16 +1,22 @@
 <?php
-// Copyright (C) 2007-2011 Rod Roark <rod@sunsetsystems.com>
-//
-// This program is free software; you can redistribute it and/or
-// modify it under the terms of the GNU General Public License
-// as published by the Free Software Foundation; either version 2
-// of the License, or (at your option) any later version.
+/**
+ * letter.php
+ *
+ * @package   OpenEMR
+ * @link      http://www.open-emr.org
+ * @author    Rod Roark <rod@sunsetsystems.com>
+ * @author    Brady Miller <brady.g.miller@gmail.com>
+ * @copyright Copyright (c) 2007-2011 Rod Roark <rod@sunsetsystems.com>
+ * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>
+ * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
+ */
+
+
+require_once("../globals.php");
+require_once($GLOBALS['srcdir'] . "/patient.inc");
 
 use OpenEMR\Core\Header;
 
-include_once("../globals.php");
-include_once($GLOBALS['srcdir'] . "/patient.inc");
-
 $template_dir = $GLOBALS['OE_SITE_DIR'] . "/letter_templates";
 
 // array of field name tags to allow internationalization
@@ -199,7 +205,12 @@
 } else if (isset($_GET['template']) && $_GET['template'] != "") {
     // utilized to go back to autosaved template
     $bodytext = "";
-    $fh = fopen("$template_dir/".$_GET['template'], 'r');
+    $fh = fopen("$template_dir/" . convert_safe_file_dir_name($_GET['template']), 'r');
+
+    if (!$fh) {
+        die(xlt("Requested template does not exist"));
+    }
+
     while (!feof($fh)) {
         $bodytext.= fread($fh, 8192);
     }
@@ -211,7 +222,12 @@
     }
 } else if ($_POST['formaction'] == "loadtemplate" && $_POST['form_template'] != "") {
     $bodytext = "";
-    $fh = fopen("$template_dir/".$_POST['form_template'], 'r');
+    $fh = fopen("$template_dir/" . convert_safe_file_dir_name($_POST['form_template']), 'r');
+
+    if (!$fh) {
+        die(xlt("Requested template does not exist"));
+    }
+
     while (!feof($fh)) {
         $bodytext.= fread($fh, 8192);
     }
@@ -223,23 +239,28 @@
     }
 } else if ($_POST['formaction'] == "newtemplate" && $_POST['newtemplatename'] != "") {
     // attempt to save the template
-    $fh = fopen("$template_dir/".$_POST['newtemplatename'], 'w');
+    $fh = fopen("$template_dir/" . convert_safe_file_dir_name($_POST['newtemplatename']), 'w');
     // translate from definition to the constant
     $temp_bodytext = $_POST['form_body'];
     foreach ($FIELD_TAG as $key => $value) {
         $temp_bodytext = str_replace("{".$value."}", "{".$key."}", $temp_bodytext);
     }
 
     if (! fwrite($fh, $temp_bodytext)) {
-        echo xlt('Error while writing to file') . ' ' . $template_dir."/".$_POST['newtemplatename'];
+        echo xlt('Error while writing to file') . ' ' . $template_dir."/" . $_POST['newtemplatename'];
         die;
     }
 
     fclose($fh);
 
     // read the saved file back
     $_POST['form_template'] = $_POST['newtemplatename'];
-    $fh = fopen("$template_dir/".$_POST['form_template'], 'r');
+    $fh = fopen("$template_dir/" . convert_safe_file_dir_name($_POST['form_template']), 'r');
+
+    if (!$fh) {
+        die(xlt("Requested template does not exist"));
+    }
+
     while (!feof($fh)) {
         $bodytext.= fread($fh, 8192);
     }
@@ -251,7 +272,7 @@
     }
 } else if ($_POST['formaction'] == "savetemplate" && $_POST['form_template'] != "") {
     // attempt to save the template
-    $fh = fopen("$template_dir/".$_POST['form_template'], 'w');
+    $fh = fopen("$template_dir/" . convert_safe_file_dir_name($_POST['form_template']), 'w');
     // translate from definition to the constant
     $temp_bodytext = $_POST['form_body'];
     foreach ($FIELD_TAG as $key => $value) {
@@ -266,7 +287,12 @@
     fclose($fh);
 
     // read the saved file back
-    $fh = fopen("$template_dir/".$_POST['form_template'], 'r');
+    $fh = fopen("$template_dir/" . convert_safe_file_dir_name($_POST['form_template']), 'r');
+
+    if (!$fh) {
+        die(xlt("Requested template does not exist"));
+    }
+
     while (!feof($fh)) {
         $bodytext.= fread($fh, 8192);
     }