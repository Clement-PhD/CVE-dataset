--- /dev/null
+++ /dev/null
@@ -95,31 +92,19 @@
     // set proper permissions on the new file
     chmod(UPLOAD_DIR . $name, 0644);
     header("location: " . $_SERVER['HTTP_REFERER']);
-    die();
 }
 
 function validateFile($filename = '')
 {
-    $knownPath = $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/'; // default path
-    $unknown = str_replace("\\", "/", realpath($filename)); // normalize requested path
-    $parts = pathinfo($unknown);
-    $unkParts = explode('/', $parts['dirname']);
-    $ptpid = $unkParts[count($unkParts) - 1]; // is this a patient or global template
-    $ptpid = ($ptpid == 'templates') ? '' : ($ptpid . '/'); // last part should be pid or template
-    $rebuiltPath = $knownPath . $ptpid . $parts['filename'] . '.tpl';
-    if (file_exists($rebuiltPath) === false || $parts['extension'] != 'tpl') {
-        redirect();
-    } elseif (realpath($rebuiltPath) != realpath($filename)) { // these need to match to be valid request
-        redirect();
-    } elseif (stripos(realpath($filename), realpath($knownPath)) === false) { // this needs to pass be a valid request
-        redirect();
+    $valid = false;
+    $filePath = $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/';
+    if (stripos($filename, $filePath) === false || !realpath($filename)) {
+        return false;
     }
-
-    return $rebuiltPath;
-}
-
-function redirect()
-{
-    header('HTTP/1.0 404 Not Found');
-    die();
+    if (preg_match("/(.*)\.(php|php3|php4|php5|php7)$/i", $filename) === 0) {
+        if (preg_match("/(.*)\.(tpl)$/i", $filename) === 1) {
+            $valid = true;
+        }
+    }
+    return $valid;
 
