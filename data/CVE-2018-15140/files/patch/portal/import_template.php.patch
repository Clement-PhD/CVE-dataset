@@ -25,16 +25,18 @@
 require_once("../interface/globals.php");
 
 if ($_POST['mode'] == 'get') {
-    if (validateFile($_POST['docid'])) {
-        echo file_get_contents($_POST['docid']);
+    $rebuilt = validateFile($_POST['docid']);
+    if ($rebuilt) {
+        echo file_get_contents($rebuilt);
         exit();
     } else {
         die(xlt('Invalid File'));
     }
 } else if ($_POST['mode'] == 'save') {
-    if (validateFile($_POST['docid'])) {
+    $rebuilt = validateFile($_POST['docid']);
+    if ($rebuilt) {
         if (stripos($_POST['content'], "<?php") === false) {
-            file_put_contents($_POST['docid'], $_POST['content']);
+            file_put_contents($rebuilt, $_POST['content']);
             exit(true);
         } else {
             die(xlt('Invalid Content'));
@@ -43,8 +45,9 @@
         die(xlt('Invalid File'));
     }
 } else if ($_POST['mode'] == 'delete') {
-    if (validateFile($_POST['docid'])) {
-        unlink($_POST['docid']);
+    $rebuilt = validateFile($_POST['docid']);
+    if ($rebuilt) {
+        unlink($rebuilt);
         exit(true);
     } else {
         die(xlt('Invalid File'));
@@ -56,7 +59,7 @@
     define("UPLOAD_DIR", $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/');
 } else {
     if ($_POST['up_dir'] > 0) {
-        define("UPLOAD_DIR", $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/' . $_POST['up_dir'] . '/');
+        define("UPLOAD_DIR", $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/' . convert_safe_file_dir_name($_POST['up_dir']) . '/');
     } else {
         define("UPLOAD_DIR", $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/');
     }
@@ -95,19 +98,31 @@
     // set proper permissions on the new file
     chmod(UPLOAD_DIR . $name, 0644);
     header("location: " . $_SERVER['HTTP_REFERER']);
+    die();
 }
 
 function validateFile($filename = '')
 {
-    $valid = false;
-    $filePath = $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/';
-    if (stripos($filename, $filePath) === false || !realpath($filename)) {
-        return false;
+    $knownPath = $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/'; // default path
+    $unknown = str_replace("\\", "/", realpath($filename)); // normalize requested path
+    $parts = pathinfo($unknown);
+    $unkParts = explode('/', $parts['dirname']);
+    $ptpid = $unkParts[count($unkParts) - 1]; // is this a patient or global template
+    $ptpid = ($ptpid == 'templates') ? '' : ($ptpid . '/'); // last part should be pid or template
+    $rebuiltPath = $knownPath . $ptpid . $parts['filename'] . '.tpl';
+    if (file_exists($rebuiltPath) === false || $parts['extension'] != 'tpl') {
+        redirect();
+    } elseif (realpath($rebuiltPath) != realpath($filename)) { // these need to match to be valid request
+        redirect();
+    } elseif (stripos(realpath($filename), realpath($knownPath)) === false) { // this needs to pass be a valid request
+        redirect();
     }
-    if (preg_match("/(.*)\.(php|php3|php4|php5|php7)$/i", $filename) === 0) {
-        if (preg_match("/(.*)\.(tpl)$/i", $filename) === 1) {
-            $valid = true;
-        }
-    }
-    return $valid;
+
+    return $rebuiltPath;
+}
+
+function redirect()
+{
+    header('HTTP/1.0 404 Not Found');
+    die();
 }
