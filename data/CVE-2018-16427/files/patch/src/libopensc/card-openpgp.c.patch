@@ -623,13 +623,19 @@ pgp_get_card_features(sc_card_t *card)
 		/* category indicator 0x00, 0x10 or 0x80 => compact TLV (ISO) */
 		switch (hist_bytes[0]) {
 			case 0x00:
-				pgp_parse_hist_bytes(card, hist_bytes+1, hist_bytes_len-4);
+				if (hist_bytes_len > 4) {
+					pgp_parse_hist_bytes(card, hist_bytes+1, hist_bytes_len-4);
+				}
 				break;
 			case 0x80:
-				pgp_parse_hist_bytes(card, hist_bytes+1, hist_bytes_len-1);
+				if (hist_bytes_len > 1) {
+					pgp_parse_hist_bytes(card, hist_bytes+1, hist_bytes_len-1);
+				}
 				break;
 			case 0x10:
-				pgp_parse_hist_bytes(card, hist_bytes+2, hist_bytes_len-2);
+				if (hist_bytes_len > 2) {
+					pgp_parse_hist_bytes(card, hist_bytes+2, hist_bytes_len-2);
+				}
 				break;
 		}
 	}
@@ -642,7 +648,9 @@ pgp_get_card_features(sc_card_t *card)
 		if ((pgp_get_blob(card, priv->mf, 0x5f52, &blob) >= 0) &&
 		    (blob->data != NULL) && (blob->data[0] == 0x00)) {
 
-			pgp_parse_hist_bytes(card, hist_bytes+1, hist_bytes_len-4);
+			if (hist_bytes_len > 4) {
+				pgp_parse_hist_bytes(card, hist_bytes+1, hist_bytes_len-4);
+			}
 
 			/* get card status from historical bytes status indicator */
 			if ((blob->data[0] == 0x00) && (blob->len >= 4)) {
@@ -1061,6 +1069,9 @@ pgp_enumerate_blob(sc_card_t *card, pgp_blob_t *blob)
 		const u8	*data = in;
 		pgp_blob_t	*new;
 
+		if (!in)
+			return SC_ERROR_OBJECT_NOT_VALID;
+
 		r = sc_asn1_read_tag(&data, blob->len - (in - blob->data),
 					&cla, &tag, &len);
 		if (r < 0 || data == NULL) {
@@ -1069,6 +1080,9 @@ pgp_enumerate_blob(sc_card_t *card, pgp_blob_t *blob)
 			return SC_ERROR_OBJECT_NOT_VALID;
 		}
 
+		if (data + len > blob->data + blob->len)
+			return SC_ERROR_OBJECT_NOT_VALID;
+
 		/* undo ASN1's split of tag & class */
 		for (tmptag = tag; tmptag > 0x0FF; tmptag >>= 8) {
 			cla <<= 8;