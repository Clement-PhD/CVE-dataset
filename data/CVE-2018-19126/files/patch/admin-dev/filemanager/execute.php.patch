@@ -10,10 +10,13 @@
     die('wrong path');
 }
 
-$thumb_pos = strpos($_POST['path_thumb'], $thumbs_base_path);
-if ($thumb_pos === false
-    || preg_match('/\.{1,2}[\/|\\\]/', $_POST['path_thumb']) !== 0
+$realPath = realpath($current_path.$_POST['path']);
+$realPathThumb = realpath($_POST['path_thumb']);
+
+if (preg_match('/\.{1,2}[\/|\\\]/', $_POST['path_thumb']) !== 0
     || preg_match('/\.{1,2}[\/|\\\]/', $_POST['path']) !== 0
+    || ($realPath && strpos($realPath, realpath($current_path)) !== 0)
+    || ($realPathThumb && strpos($realPathThumb, realpath($thumbs_base_path)) !== 0)
 ) {
     die('wrong path');
 }
@@ -70,6 +73,7 @@
     switch ($_GET['action']) {
         case 'delete_file':
             if ($delete_files) {
+                stopIfSameDir($current_path, array($path, $path_thumb));
                 unlink($path);
                 if (file_exists($path_thumb)) {
                     unlink($path_thumb);
@@ -102,9 +106,11 @@
             break;
         case 'delete_folder':
             if ($delete_folders) {
+                stopIfSameDir($current_path, array($path, $path_thumb));
                 if (is_dir($path_thumb)) {
                     deleteDir($path_thumb);
                 }
+
                 if (is_dir($path)) {
                     deleteDir($path);
                     if ($fixed_image_creation) {
@@ -132,6 +138,7 @@
                 $name = str_replace('.', '', $name);
 
                 if (!empty($name)) {
+                    stopIfSameDir($current_path, array($path, $path_thumb));
                     if (!rename_folder($path, $name, $transliteration)) {
                         die(lang_Rename_existing_folder);
                     }
@@ -154,6 +161,7 @@
             if ($rename_files) {
                 $name = fix_filename($name, $transliteration);
                 if (!empty($name)) {
+                    stopIfSameDir($current_path, array($path, $path_thumb));
                     if (!rename_file($path, $name, $transliteration)) {
                         die(lang_Rename_existing_file);
                     }