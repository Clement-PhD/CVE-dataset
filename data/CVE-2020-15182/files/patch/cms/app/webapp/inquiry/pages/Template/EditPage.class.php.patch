@@ -5,7 +5,16 @@ class EditPage extends WebPage{
 	var $target;
 	
 	function doPost(){
-		
+		// Referer, Token Check
+		$referer = parse_url($_SERVER['HTTP_REFERER']);
+		$_host = ($referer['host'] === $_SERVER['HTTP_HOST']);
+		$_path = (($referer['path'] . "?" . $_SERVER['QUERY_STRING']) === $_SERVER['REQUEST_URI']);
+		$_token = soy2_check_token();
+		if(!($_host && $_path && $_token)){
+  			CMSApplication::jump("Template");
+			exit;
+		}
+
 		$target = $this->target;
   		$dir = SOY2::RootDir() . "template/";
   		if(!file_exists($dir . $target) || !is_writable($dir.$target)){
@@ -27,8 +36,8 @@ function doPost(){
 	}
 	
     function __construct() {
-  		
   		$target = @$_GET["target"];
+  		$target = str_replace(Array("..", "\\"), "", $target);
   		$this->target = $target;
   		$dir = SOY2::RootDir() . "template/";
   		if(!file_exists($dir . $target) || !is_writable($dir.$target)){
@@ -42,6 +51,12 @@ function __construct() {
   		
   		$content = file_get_contents($path);
   		
+
+  		$this->addInput("soy2_token", array(
+			"name" => "soy2_token",
+			"value" => soy2_get_token()
+		));
+
   		$this->createAdd("target","HTMLLabel",array(
   			"text" => $target
   		));
@@ -52,4 +67,4 @@ function __construct() {
   		));
 	}
 }
-?>
\ No newline at end of file
+?>
