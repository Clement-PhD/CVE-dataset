@@ -501,7 +501,7 @@ static ssize_t http_build_trailer(http_context *ctx, swString *response) {
             if (UNEXPECTED(!key || ZVAL_IS_NULL(zvalue))) {
                 continue;
             }
-            
+
             if (!ZVAL_IS_NULL(zvalue)) {
                 zend::String str_value(zvalue);
                 n = sw_snprintf(
@@ -830,6 +830,20 @@ bool swoole_http_response_set_header(
         if (UNEXPECTED(!v)) {
             add_assoc_null_ex(zheader, key_buf, klen);
         } else {
+            /* new line/NUL character safety check */
+            uint32_t i;
+            for (i = 0; i < vlen; i++) {
+                /* RFC 7230 ch. 3.2.4 deprecates folding support */
+                if (v[i] == '\n' || v[i] == '\r') {
+                    php_swoole_error(E_WARNING, "Header may not contain more than a single header, new line detected");
+                    return false;
+                }
+                if (v[i] == '\0') {
+                    php_swoole_error(E_WARNING, "Header may not contain NUL bytes");
+                    return false;
+                }
+            }
+
             add_assoc_stringl_ex(zheader, key_buf, klen, (char *) v, vlen);
         }
     } else {