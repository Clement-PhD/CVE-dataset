@@ -11,7 +11,7 @@
  * License: GNU/GPLv2
  * @see LICENSE.txt
  *
- * This file: CLI handler (last modified: 2018.07.31).
+ * This file: CLI handler (last modified: 2018.10.17).
  */
 
 /** Prevents execution from outside of phpMussel. */
@@ -104,82 +104,81 @@
             echo $phpMussel['CLI-RecursiveCommand']($phpMussel['cli_args'][2], function ($Params) use (&$phpMussel) {
                 $Data = $phpMussel['ReadFile']($Params, 0, true);
                 $Returnable = '';
-                if (substr($Data, 0, 2) === 'MZ') {
-                    $PEArr = [];
-                    $PEArr['Len'] = strlen($Data);
-                    $PEArr['Offset'] = $phpMussel['UnpackSafe']('S', substr($Data, 60, 4));
-                    $PEArr['Offset'] = $PEArr['Offset'][1];
-                    while (true) {
-                        $PEArr['DoScan'] = true;
-                        if ($PEArr['Offset'] < 1 || $PEArr['Offset'] > 16384 || $PEArr['Offset'] > $PEArr['Len']) {
-                            $PEArr['DoScan'] = false;
-                            break;
-                        }
-                        $PEArr['Magic'] = substr($Data, $PEArr['Offset'], 2);
-                        if ($PEArr['Magic'] !== 'PE') {
-                            $PEArr['DoScan'] = false;
-                            break;
-                        }
-                        $PEArr['Proc'] = $phpMussel['UnpackSafe']('S', substr($Data, $PEArr['Offset'] + 4, 2));
-                        $PEArr['Proc'] = $PEArr['Proc'][1];
-                        if ($PEArr['Proc'] != 0x14c && $PEArr['Proc'] != 0x8664) {
-                            $PEArr['DoScan'] = false;
-                            break;
-                        }
-                        $PEArr['NumOfSections'] = $phpMussel['UnpackSafe']('S', substr($Data, $PEArr['Offset'] + 6, 2));
-                        $PEArr['NumOfSections'] = $PEArr['NumOfSections'][1];
-                        if ($PEArr['NumOfSections'] < 1 || $PEArr['NumOfSections'] > 40) {
-                            $PEArr['DoScan'] = false;
-                        }
+                if (substr($Data, 0, 2) !== 'MZ') {
+                    return $phpMussel['lang']['cli_pe1'] . "\n";
+                }
+                $PEArr = ['Len' => strlen($Data)];
+                $PEArr['Offset'] = $phpMussel['UnpackSafe']('S', substr($Data, 60, 4));
+                $PEArr['Offset'] = $PEArr['Offset'][1];
+                while (true) {
+                    $PEArr['DoScan'] = true;
+                    if ($PEArr['Offset'] < 1 || $PEArr['Offset'] > 16384 || $PEArr['Offset'] > $PEArr['Len']) {
+                        $PEArr['DoScan'] = false;
                         break;
                     }
-                    if (!$PEArr['DoScan']) {
-                        return $phpMussel['lang']['cli_pe1'] . "\n";
+                    $PEArr['Magic'] = substr($Data, $PEArr['Offset'], 2);
+                    if ($PEArr['Magic'] !== 'PE') {
+                        $PEArr['DoScan'] = false;
+                        break;
                     }
-                    $PEArr['OptHdrSize'] = $phpMussel['UnpackSafe']('S', substr($Data, $PEArr['Offset'] + 20, 2));
-                    $PEArr['OptHdrSize'] = $PEArr['OptHdrSize'][1];
-                    $Returnable .= $phpMussel['lang']['cli_pe2'] . "\n";
-                    for ($PEArr['k'] = 0; $PEArr['k'] < $PEArr['NumOfSections']; $PEArr['k']++) {
-                        $PEArr['SectionHead'] = substr($Data, $PEArr['Offset'] + 24 + $PEArr['OptHdrSize'] + ($PEArr['k'] * 40), $PEArr['NumOfSections'] * 40);
-                        $PEArr['SectionName'] = str_ireplace("\x00", '', substr($PEArr['SectionHead'], 0, 8));
-                        $PEArr['VirtualSize'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 8, 4));
-                        $PEArr['VirtualSize'] = $PEArr['VirtualSize'][1];
-                        $PEArr['VirtualAddress'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 12, 4));
-                        $PEArr['VirtualAddress'] = $PEArr['VirtualAddress'][1];
-                        $PEArr['SizeOfRawData'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 16, 4));
-                        $PEArr['SizeOfRawData'] = $PEArr['SizeOfRawData'][1];
-                        $PEArr['PointerToRawData'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 20, 4));
-                        $PEArr['PointerToRawData'] = $PEArr['PointerToRawData'][1];
-                        $PEArr['SectionData'] = substr($Data, $PEArr['PointerToRawData'], $PEArr['SizeOfRawData']);
-                        $PEArr['MD5'] = md5($PEArr['SectionData']);
-                        $Returnable .= $PEArr['SizeOfRawData'] . ':' . $PEArr['MD5'] . ':' . $PEArr['SectionName'] . "\n";
+                    $PEArr['Proc'] = $phpMussel['UnpackSafe']('S', substr($Data, $PEArr['Offset'] + 4, 2));
+                    $PEArr['Proc'] = $PEArr['Proc'][1];
+                    if ($PEArr['Proc'] != 0x14c && $PEArr['Proc'] != 0x8664) {
+                        $PEArr['DoScan'] = false;
+                        break;
+                    }
+                    $PEArr['NumOfSections'] = $phpMussel['UnpackSafe']('S', substr($Data, $PEArr['Offset'] + 6, 2));
+                    $PEArr['NumOfSections'] = $PEArr['NumOfSections'][1];
+                    if ($PEArr['NumOfSections'] < 1 || $PEArr['NumOfSections'] > 40) {
+                        $PEArr['DoScan'] = false;
                     }
-                    $Returnable .= "\n";
-                    if (strpos($Data, "V\x00a\x00r\x00F\x00i\x00l\x00e\x00I\x00n\x00f\x00o\x00\x00\x00\x00\x00\x24") !== false) {
-                        $PEArr['Parts'] = $phpMussel['substral']($Data, "V\x00a\x00r\x00F\x00i\x00l\x00e\x00I\x00n\x00f\x00o\x00\x00\x00\x00\x00\x24");
-                        $PEArr['FINFO'] = [];
-                        foreach ([
-                            ["F\x00i\x00l\x00e\x00D\x00e\x00s\x00c\x00r\x00i\x00p\x00t\x00i\x00o\x00n\x00\x00\x00", 'PEFileDescription'],
-                            ["F\x00i\x00l\x00e\x00V\x00e\x00r\x00s\x00i\x00o\x00n\x00\x00\x00", 'PEFileVersion'],
-                            ["P\x00r\x00o\x00d\x00u\x00c\x00t\x00N\x00a\x00m\x00e\x00\x00\x00", 'PEProductName'],
-                            ["P\x00r\x00o\x00d\x00u\x00c\x00t\x00V\x00e\x00r\x00s\x00i\x00o\x00n\x00\x00\x00", 'PEProductVersion'],
-                            ["L\x00e\x00g\x00a\x00l\x00C\x00o\x00p\x00y\x00r\x00i\x00g\x00h\x00t\x00\x00\x00", 'PECopyright'],
-                            ["O\x00r\x00i\x00g\x00i\x00n\x00a\x00l\x00F\x00i\x00l\x00e\x00n\x00a\x00m\x00e\x00\x00\x00", 'PEOriginalFilename'],
-                            ["C\x00o\x00m\x00p\x00a\x00n\x00y\x00N\x00a\x00m\x00e\x00\x00\x00", 'PECompanyName'],
-                        ] as $PEVars) {
-                            if (strpos($PEArr['Parts'], $PEVars[0]) !== false && (
-                                $PEArr['ThisData'] = trim(str_ireplace("\x00", '', $phpMussel['substrbf'](
-                                    $phpMussel['substral']($PEArr['Parts'], $PEVars[0]),
-                                    "\x00\x00\x00"
-                                )))
-                            )) {
-                                $Returnable .= '$' . $PEVars[1] . ':' . md5($PEArr['ThisData']) . ':' . strlen($PEArr['ThisData']) . ':' . $phpMussel['lang']['cli_signature_placeholder'] . "\n";
-                            }
+                    break;
+                }
+                if (!$PEArr['DoScan']) {
+                    return $phpMussel['lang']['cli_pe1'] . "\n";
+                }
+                $PEArr['OptHdrSize'] = $phpMussel['UnpackSafe']('S', substr($Data, $PEArr['Offset'] + 20, 2));
+                $PEArr['OptHdrSize'] = $PEArr['OptHdrSize'][1];
+                $Returnable .= $phpMussel['lang']['cli_pe2'] . "\n";
+                for ($PEArr['k'] = 0; $PEArr['k'] < $PEArr['NumOfSections']; $PEArr['k']++) {
+                    $PEArr['SectionHead'] = substr($Data, $PEArr['Offset'] + 24 + $PEArr['OptHdrSize'] + ($PEArr['k'] * 40), $PEArr['NumOfSections'] * 40);
+                    $PEArr['SectionName'] = str_ireplace("\x00", '', substr($PEArr['SectionHead'], 0, 8));
+                    $PEArr['VirtualSize'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 8, 4));
+                    $PEArr['VirtualSize'] = $PEArr['VirtualSize'][1];
+                    $PEArr['VirtualAddress'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 12, 4));
+                    $PEArr['VirtualAddress'] = $PEArr['VirtualAddress'][1];
+                    $PEArr['SizeOfRawData'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 16, 4));
+                    $PEArr['SizeOfRawData'] = $PEArr['SizeOfRawData'][1];
+                    $PEArr['PointerToRawData'] = $phpMussel['UnpackSafe']('S', substr($PEArr['SectionHead'], 20, 4));
+                    $PEArr['PointerToRawData'] = $PEArr['PointerToRawData'][1];
+                    $PEArr['SectionData'] = substr($Data, $PEArr['PointerToRawData'], $PEArr['SizeOfRawData']);
+                    $PEArr['MD5'] = md5($PEArr['SectionData']);
+                    $Returnable .= $PEArr['SizeOfRawData'] . ':' . $PEArr['MD5'] . ':' . $PEArr['SectionName'] . "\n";
+                }
+                $Returnable .= "\n";
+                if (strpos($Data, "V\x00a\x00r\x00F\x00i\x00l\x00e\x00I\x00n\x00f\x00o\x00\x00\x00\x00\x00\x24") !== false) {
+                    $PEArr['Parts'] = $phpMussel['substral']($Data, "V\x00a\x00r\x00F\x00i\x00l\x00e\x00I\x00n\x00f\x00o\x00\x00\x00\x00\x00\x24");
+                    $PEArr['FINFO'] = [];
+                    foreach ([
+                        ["F\x00i\x00l\x00e\x00D\x00e\x00s\x00c\x00r\x00i\x00p\x00t\x00i\x00o\x00n\x00\x00\x00", 'PEFileDescription'],
+                        ["F\x00i\x00l\x00e\x00V\x00e\x00r\x00s\x00i\x00o\x00n\x00\x00\x00", 'PEFileVersion'],
+                        ["P\x00r\x00o\x00d\x00u\x00c\x00t\x00N\x00a\x00m\x00e\x00\x00\x00", 'PEProductName'],
+                        ["P\x00r\x00o\x00d\x00u\x00c\x00t\x00V\x00e\x00r\x00s\x00i\x00o\x00n\x00\x00\x00", 'PEProductVersion'],
+                        ["L\x00e\x00g\x00a\x00l\x00C\x00o\x00p\x00y\x00r\x00i\x00g\x00h\x00t\x00\x00\x00", 'PECopyright'],
+                        ["O\x00r\x00i\x00g\x00i\x00n\x00a\x00l\x00F\x00i\x00l\x00e\x00n\x00a\x00m\x00e\x00\x00\x00", 'PEOriginalFilename'],
+                        ["C\x00o\x00m\x00p\x00a\x00n\x00y\x00N\x00a\x00m\x00e\x00\x00\x00", 'PECompanyName'],
+                    ] as $PEVars) {
+                        if (strpos($PEArr['Parts'], $PEVars[0]) !== false && (
+                            $PEArr['ThisData'] = trim(str_ireplace("\x00", '', $phpMussel['substrbf'](
+                                $phpMussel['substral']($PEArr['Parts'], $PEVars[0]),
+                                "\x00\x00\x00"
+                            )))
+                        )) {
+                            $Returnable .= '$' . $PEVars[1] . ':' . md5($PEArr['ThisData']) . ':' . strlen($PEArr['ThisData']) . ':' . $phpMussel['lang']['cli_signature_placeholder'] . "\n";
                         }
                     }
-                    return $Returnable;
                 }
-                return $phpMussel['lang']['cli_pe1'] . "\n";
+                return $Returnable;
             });
         }
 