@@ -17,12 +17,17 @@
 package org.gradle.api.internal.filestore;
 
 import org.gradle.api.Namer;
+import org.gradle.api.internal.artifacts.ivyservice.ArtifactCacheMetadata;
 import org.gradle.api.internal.file.TemporaryFileProvider;
+import org.gradle.api.internal.file.TmpDirTemporaryFileProvider;
 import org.gradle.internal.component.external.model.ModuleComponentArtifactIdentifier;
 import org.gradle.internal.file.FileAccessTimeJournal;
 import org.gradle.internal.hash.ChecksumService;
 import org.gradle.internal.resource.local.GroupedAndNamedUniqueFileStore;
+import org.gradle.internal.service.scopes.Scopes;
+import org.gradle.internal.service.scopes.ServiceScope;
 
+import javax.inject.Inject;
 import java.io.File;
 
 public class DefaultArtifactIdentifierFileStore extends GroupedAndNamedUniqueFileStore<ModuleComponentArtifactIdentifier> implements ArtifactIdentifierFileStore {
@@ -44,7 +49,30 @@ public int getNumberOfGroupingDirs() {
 
     private static final Namer<ModuleComponentArtifactIdentifier> NAMER = ModuleComponentArtifactIdentifier::getFileName;
 
-    public DefaultArtifactIdentifierFileStore(File baseDir, TemporaryFileProvider temporaryFileProvider, FileAccessTimeJournal fileAccessTimeJournal, ChecksumService checksumService) {
+    private DefaultArtifactIdentifierFileStore(File baseDir, TemporaryFileProvider temporaryFileProvider, FileAccessTimeJournal fileAccessTimeJournal, ChecksumService checksumService) {
         super(baseDir, temporaryFileProvider, fileAccessTimeJournal, GROUPER, NAMER, checksumService);
     }
+
+    @ServiceScope(Scopes.Build.class)
+    public static class Factory {
+        private final TmpDirTemporaryFileProvider tmpDirTemporaryFileProvider;
+        private final FileAccessTimeJournal fileAccessTimeJournal;
+        private final ChecksumService checksumService;
+
+        @Inject
+        public Factory(TmpDirTemporaryFileProvider tmpDirTemporaryFileProvider, FileAccessTimeJournal fileAccessTimeJournal, ChecksumService checksumService) {
+            this.tmpDirTemporaryFileProvider = tmpDirTemporaryFileProvider;
+            this.fileAccessTimeJournal = fileAccessTimeJournal;
+            this.checksumService = checksumService;
+        }
+
+        public DefaultArtifactIdentifierFileStore create(ArtifactCacheMetadata artifactCacheMetadata) {
+            return new DefaultArtifactIdentifierFileStore(
+                artifactCacheMetadata.getFileStoreDirectory(),
+                tmpDirTemporaryFileProvider,
+                fileAccessTimeJournal,
+                checksumService
+            );
+        }
+    }
 }
