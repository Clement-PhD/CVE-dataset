@@ -110,7 +110,7 @@ class SegmentReductionOp : public OpKernel {
                 errors::InvalidArgument("Shape must be at least rank 1"));
 
     TensorShape output_shape = input.shape();
-    output_shape.set_dim(0, output_rows);
+    OP_REQUIRES_OK(context, output_shape.SetDimWithStatus(0, output_rows));
 
     // Note that we do not initialize the output buffer with a default value, so
     // we need to explicitly set missing indices to the default value.
@@ -250,7 +250,7 @@ class SegmentReductionGPUOp : public AsyncOpKernel {
 
     if (num_indices == 0) {
       TensorShape output_shape = input.shape();
-      output_shape.set_dim(0, 0);
+      OP_REQUIRES_OK_ASYNC(context, output_shape.SetDimWithStatus(0, 0), done);
 
       Tensor* output = nullptr;
       OP_REQUIRES_OK_ASYNC(