{
    "url": "https://api.github.com/repos/matrix-org/synapse/pulls/13723",
    "id": 1047403417,
    "node_id": "PR_kwDOAVyVwM4-bhuZ",
    "html_url": "https://github.com/matrix-org/synapse/pull/13723",
    "diff_url": "https://github.com/matrix-org/synapse/pull/13723.diff",
    "patch_url": "https://github.com/matrix-org/synapse/pull/13723.patch",
    "issue_url": "https://api.github.com/repos/matrix-org/synapse/issues/13723",
    "number": 13723,
    "state": "closed",
    "locked": true,
    "title": "Avoid putting rejected events in room state",
    "user": {
        "login": "squahtx",
        "id": 8349537,
        "node_id": "MDQ6VXNlcjgzNDk1Mzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8349537?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/squahtx",
        "html_url": "https://github.com/squahtx",
        "followers_url": "https://api.github.com/users/squahtx/followers",
        "following_url": "https://api.github.com/users/squahtx/following{/other_user}",
        "gists_url": "https://api.github.com/users/squahtx/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/squahtx/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/squahtx/subscriptions",
        "organizations_url": "https://api.github.com/users/squahtx/orgs",
        "repos_url": "https://api.github.com/users/squahtx/repos",
        "events_url": "https://api.github.com/users/squahtx/events{/privacy}",
        "received_events_url": "https://api.github.com/users/squahtx/received_events",
        "type": "User",
        "site_admin": false
    },
    "body": "When receiving an event over federation which has prev events not known\r\nlocally, Synapse will request the state before the unknown prev events\r\nfrom a remote server. It is possible for the remote server to disagree\r\non the rejected-ness of events and return a state that includes locally\r\nrejected events.\r\n\r\nDuring state resolution, we replay state events and re-evaluate the part\r\nof their auth that checks against room state. Thus it is possible for\r\nevents that have been rejected due to citing rejected auth events to be\r\naccepted into the current room state at the forward extremities.\r\n\r\nWhile the spec implies that this may be intended behaviour depending on\r\nthe reason the auth event was rejected, this creates problems for\r\nSynapse, since we assume that previously rejected events cannot make it\r\ninto room state and do not populate tables such as `room_memberships`\r\nfor them.\r\n\r\nFor now, we amend state resolution to not admit previously rejected\r\nevents in the calculated state.\r\n\r\n---\r\n\r\n<details>\r\n<summary>Previous notes</summary>\r\n\r\nIt's unclear to me whether the proposed change to state resolution is valid.\r\n\r\nThe spec says\r\n> Events that have been rejected due to failing auth based on the state at the event (rather than based on their auth chain) are handled as usual by the algorithm, unless otherwise specified.\r\n\r\nwhich seems to imply that there are a class of rejected events that _should_ make their way into the current room state.\r\n\r\nThe spec also says\r\n\r\n> Note that no events rejected due to failure to auth against their auth chain should appear in the process, as they should not appear in state (the algorithm only uses events that appear in either the state sets or in the auth chain of the events in the state sets).\r\n>\r\n> RATIONALE\r\n> This helps ensure that different servers\u2019 view of state is more likely to converge, since rejection state of an event may be different. This can happen if a third server gives an incorrect version of the state when a server joins a room via it (either due to being faulty or malicious). Convergence of state is a desirable property as it ensures that all users in the room have a (mostly) consistent view of the state of the room. If the view of the state on different servers diverges it can lead to bifurcation of the room due to e.g. servers disagreeing on who is in the room.\r\n\r\nwhich seems to imply that events rejected because their auth events have been rejected should not appear in the calculated state (regardless of the reason their auth events have been rejected?). But then the rationale doesn't really work out, since chains of auth events rejected due to citing rejected auth events will remain rejected, regardless of the rejection reason at the start of the chain.\r\n\r\n---\r\n\r\n> When receiving an event over federation which has prev events not known\r\n> locally, Synapse will request the state before the unknown prev events\r\n> from a remote server. It is possible for the remote server to disagree\r\n> on the rejected-ness of events and return a state that includes locally\r\n> rejected events.\r\n\r\nI think it's possible for parts of the DAG to have state that includes rejected events and modifying state resolution doesn't change this. I'm unsure about the implications of this.\r\n\r\n</details>",
    "created_at": "2022-09-06T10:56:53Z",
    "updated_at": "2022-09-16T11:45:05Z",
    "closed_at": "2022-09-16T11:45:05Z",
    "merged_at": "2022-09-16T11:45:05Z",
    "merge_commit_sha": "b73cbb82157d9666e8d667733afebc0d09ed858c",
    "assignee": null,
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "labels": [],
    "milestone": null,
    "draft": false,
    "commits_url": "https://api.github.com/repos/matrix-org/synapse/pulls/13723/commits",
    "review_comments_url": "https://api.github.com/repos/matrix-org/synapse/pulls/13723/comments",
    "review_comment_url": "https://api.github.com/repos/matrix-org/synapse/pulls/comments{/number}",
    "comments_url": "https://api.github.com/repos/matrix-org/synapse/issues/13723/comments",
    "statuses_url": "https://api.github.com/repos/matrix-org/synapse/statuses/be4c8ebc2f3dc2747b21647378e11569cc642f1e",
    "head": {
        "label": "matrix-org:squah/fix_rejected_events_in_state",
        "ref": "squah/fix_rejected_events_in_state",
        "sha": "be4c8ebc2f3dc2747b21647378e11569cc642f1e",
        "user": {
            "login": "matrix-org",
            "id": 8418310,
            "node_id": "MDEyOk9yZ2FuaXphdGlvbjg0MTgzMTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/8418310?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/matrix-org",
            "html_url": "https://github.com/matrix-org",
            "followers_url": "https://api.github.com/users/matrix-org/followers",
            "following_url": "https://api.github.com/users/matrix-org/following{/other_user}",
            "gists_url": "https://api.github.com/users/matrix-org/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/matrix-org/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/matrix-org/subscriptions",
            "organizations_url": "https://api.github.com/users/matrix-org/orgs",
            "repos_url": "https://api.github.com/users/matrix-org/repos",
            "events_url": "https://api.github.com/users/matrix-org/events{/privacy}",
            "received_events_url": "https://api.github.com/users/matrix-org/received_events",
            "type": "Organization",
            "site_admin": false
        },
        "repo": {
            "id": 22844864,
            "node_id": "MDEwOlJlcG9zaXRvcnkyMjg0NDg2NA==",
            "name": "synapse",
            "full_name": "matrix-org/synapse",
            "private": false,
            "owner": {
                "login": "matrix-org",
                "id": 8418310,
                "node_id": "MDEyOk9yZ2FuaXphdGlvbjg0MTgzMTA=",
                "avatar_url": "https://avatars.githubusercontent.com/u/8418310?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/matrix-org",
                "html_url": "https://github.com/matrix-org",
                "followers_url": "https://api.github.com/users/matrix-org/followers",
                "following_url": "https://api.github.com/users/matrix-org/following{/other_user}",
                "gists_url": "https://api.github.com/users/matrix-org/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/matrix-org/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matrix-org/subscriptions",
                "organizations_url": "https://api.github.com/users/matrix-org/orgs",
                "repos_url": "https://api.github.com/users/matrix-org/repos",
                "events_url": "https://api.github.com/users/matrix-org/events{/privacy}",
                "received_events_url": "https://api.github.com/users/matrix-org/received_events",
                "type": "Organization",
                "site_admin": false
            },
            "html_url": "https://github.com/matrix-org/synapse",
            "description": "Synapse: Matrix homeserver written in Python/Twisted.",
            "fork": false,
            "url": "https://api.github.com/repos/matrix-org/synapse",
            "forks_url": "https://api.github.com/repos/matrix-org/synapse/forks",
            "keys_url": "https://api.github.com/repos/matrix-org/synapse/keys{/key_id}",
            "collaborators_url": "https://api.github.com/repos/matrix-org/synapse/collaborators{/collaborator}",
            "teams_url": "https://api.github.com/repos/matrix-org/synapse/teams",
            "hooks_url": "https://api.github.com/repos/matrix-org/synapse/hooks",
            "issue_events_url": "https://api.github.com/repos/matrix-org/synapse/issues/events{/number}",
            "events_url": "https://api.github.com/repos/matrix-org/synapse/events",
            "assignees_url": "https://api.github.com/repos/matrix-org/synapse/assignees{/user}",
            "branches_url": "https://api.github.com/repos/matrix-org/synapse/branches{/branch}",
            "tags_url": "https://api.github.com/repos/matrix-org/synapse/tags",
            "blobs_url": "https://api.github.com/repos/matrix-org/synapse/git/blobs{/sha}",
            "git_tags_url": "https://api.github.com/repos/matrix-org/synapse/git/tags{/sha}",
            "git_refs_url": "https://api.github.com/repos/matrix-org/synapse/git/refs{/sha}",
            "trees_url": "https://api.github.com/repos/matrix-org/synapse/git/trees{/sha}",
            "statuses_url": "https://api.github.com/repos/matrix-org/synapse/statuses/{sha}",
            "languages_url": "https://api.github.com/repos/matrix-org/synapse/languages",
            "stargazers_url": "https://api.github.com/repos/matrix-org/synapse/stargazers",
            "contributors_url": "https://api.github.com/repos/matrix-org/synapse/contributors",
            "subscribers_url": "https://api.github.com/repos/matrix-org/synapse/subscribers",
            "subscription_url": "https://api.github.com/repos/matrix-org/synapse/subscription",
            "commits_url": "https://api.github.com/repos/matrix-org/synapse/commits{/sha}",
            "git_commits_url": "https://api.github.com/repos/matrix-org/synapse/git/commits{/sha}",
            "comments_url": "https://api.github.com/repos/matrix-org/synapse/comments{/number}",
            "issue_comment_url": "https://api.github.com/repos/matrix-org/synapse/issues/comments{/number}",
            "contents_url": "https://api.github.com/repos/matrix-org/synapse/contents/{+path}",
            "compare_url": "https://api.github.com/repos/matrix-org/synapse/compare/{base}...{head}",
            "merges_url": "https://api.github.com/repos/matrix-org/synapse/merges",
            "archive_url": "https://api.github.com/repos/matrix-org/synapse/{archive_format}{/ref}",
            "downloads_url": "https://api.github.com/repos/matrix-org/synapse/downloads",
            "issues_url": "https://api.github.com/repos/matrix-org/synapse/issues{/number}",
            "pulls_url": "https://api.github.com/repos/matrix-org/synapse/pulls{/number}",
            "milestones_url": "https://api.github.com/repos/matrix-org/synapse/milestones{/number}",
            "notifications_url": "https://api.github.com/repos/matrix-org/synapse/notifications{?since,all,participating}",
            "labels_url": "https://api.github.com/repos/matrix-org/synapse/labels{/name}",
            "releases_url": "https://api.github.com/repos/matrix-org/synapse/releases{/id}",
            "deployments_url": "https://api.github.com/repos/matrix-org/synapse/deployments",
            "created_at": "2014-08-11T15:51:42Z",
            "updated_at": "2023-12-20T23:17:04Z",
            "pushed_at": "2023-12-14T07:12:07Z",
            "git_url": "git://github.com/matrix-org/synapse.git",
            "ssh_url": "git@github.com:matrix-org/synapse.git",
            "clone_url": "https://github.com/matrix-org/synapse.git",
            "svn_url": "https://github.com/matrix-org/synapse",
            "homepage": "https://matrix-org.github.io/synapse",
            "size": 431700,
            "stargazers_count": 11728,
            "watchers_count": 11728,
            "language": "Python",
            "has_issues": true,
            "has_projects": true,
            "has_downloads": true,
            "has_wiki": true,
            "has_pages": true,
            "has_discussions": false,
            "forks_count": 2195,
            "mirror_url": null,
            "archived": true,
            "disabled": false,
            "open_issues_count": 1518,
            "license": {
                "key": "apache-2.0",
                "name": "Apache License 2.0",
                "spdx_id": "Apache-2.0",
                "url": "https://api.github.com/licenses/apache-2.0",
                "node_id": "MDc6TGljZW5zZTI="
            },
            "allow_forking": true,
            "is_template": false,
            "web_commit_signoff_required": false,
            "topics": [
                "matrix-org",
                "python"
            ],
            "visibility": "public",
            "forks": 2195,
            "open_issues": 1518,
            "watchers": 11728,
            "default_branch": "develop"
        }
    },
    "base": {
        "label": "matrix-org:develop",
        "ref": "develop",
        "sha": "918c74bfb57e3ca4d300ed9a3bfb99b99126f821",
        "user": {
            "login": "matrix-org",
            "id": 8418310,
            "node_id": "MDEyOk9yZ2FuaXphdGlvbjg0MTgzMTA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/8418310?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/matrix-org",
            "html_url": "https://github.com/matrix-org",
            "followers_url": "https://api.github.com/users/matrix-org/followers",
            "following_url": "https://api.github.com/users/matrix-org/following{/other_user}",
            "gists_url": "https://api.github.com/users/matrix-org/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/matrix-org/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/matrix-org/subscriptions",
            "organizations_url": "https://api.github.com/users/matrix-org/orgs",
            "repos_url": "https://api.github.com/users/matrix-org/repos",
            "events_url": "https://api.github.com/users/matrix-org/events{/privacy}",
            "received_events_url": "https://api.github.com/users/matrix-org/received_events",
            "type": "Organization",
            "site_admin": false
        },
        "repo": {
            "id": 22844864,
            "node_id": "MDEwOlJlcG9zaXRvcnkyMjg0NDg2NA==",
            "name": "synapse",
            "full_name": "matrix-org/synapse",
            "private": false,
            "owner": {
                "login": "matrix-org",
                "id": 8418310,
                "node_id": "MDEyOk9yZ2FuaXphdGlvbjg0MTgzMTA=",
                "avatar_url": "https://avatars.githubusercontent.com/u/8418310?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/matrix-org",
                "html_url": "https://github.com/matrix-org",
                "followers_url": "https://api.github.com/users/matrix-org/followers",
                "following_url": "https://api.github.com/users/matrix-org/following{/other_user}",
                "gists_url": "https://api.github.com/users/matrix-org/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/matrix-org/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matrix-org/subscriptions",
                "organizations_url": "https://api.github.com/users/matrix-org/orgs",
                "repos_url": "https://api.github.com/users/matrix-org/repos",
                "events_url": "https://api.github.com/users/matrix-org/events{/privacy}",
                "received_events_url": "https://api.github.com/users/matrix-org/received_events",
                "type": "Organization",
                "site_admin": false
            },
            "html_url": "https://github.com/matrix-org/synapse",
            "description": "Synapse: Matrix homeserver written in Python/Twisted.",
            "fork": false,
            "url": "https://api.github.com/repos/matrix-org/synapse",
            "forks_url": "https://api.github.com/repos/matrix-org/synapse/forks",
            "keys_url": "https://api.github.com/repos/matrix-org/synapse/keys{/key_id}",
            "collaborators_url": "https://api.github.com/repos/matrix-org/synapse/collaborators{/collaborator}",
            "teams_url": "https://api.github.com/repos/matrix-org/synapse/teams",
            "hooks_url": "https://api.github.com/repos/matrix-org/synapse/hooks",
            "issue_events_url": "https://api.github.com/repos/matrix-org/synapse/issues/events{/number}",
            "events_url": "https://api.github.com/repos/matrix-org/synapse/events",
            "assignees_url": "https://api.github.com/repos/matrix-org/synapse/assignees{/user}",
            "branches_url": "https://api.github.com/repos/matrix-org/synapse/branches{/branch}",
            "tags_url": "https://api.github.com/repos/matrix-org/synapse/tags",
            "blobs_url": "https://api.github.com/repos/matrix-org/synapse/git/blobs{/sha}",
            "git_tags_url": "https://api.github.com/repos/matrix-org/synapse/git/tags{/sha}",
            "git_refs_url": "https://api.github.com/repos/matrix-org/synapse/git/refs{/sha}",
            "trees_url": "https://api.github.com/repos/matrix-org/synapse/git/trees{/sha}",
            "statuses_url": "https://api.github.com/repos/matrix-org/synapse/statuses/{sha}",
            "languages_url": "https://api.github.com/repos/matrix-org/synapse/languages",
            "stargazers_url": "https://api.github.com/repos/matrix-org/synapse/stargazers",
            "contributors_url": "https://api.github.com/repos/matrix-org/synapse/contributors",
            "subscribers_url": "https://api.github.com/repos/matrix-org/synapse/subscribers",
            "subscription_url": "https://api.github.com/repos/matrix-org/synapse/subscription",
            "commits_url": "https://api.github.com/repos/matrix-org/synapse/commits{/sha}",
            "git_commits_url": "https://api.github.com/repos/matrix-org/synapse/git/commits{/sha}",
            "comments_url": "https://api.github.com/repos/matrix-org/synapse/comments{/number}",
            "issue_comment_url": "https://api.github.com/repos/matrix-org/synapse/issues/comments{/number}",
            "contents_url": "https://api.github.com/repos/matrix-org/synapse/contents/{+path}",
            "compare_url": "https://api.github.com/repos/matrix-org/synapse/compare/{base}...{head}",
            "merges_url": "https://api.github.com/repos/matrix-org/synapse/merges",
            "archive_url": "https://api.github.com/repos/matrix-org/synapse/{archive_format}{/ref}",
            "downloads_url": "https://api.github.com/repos/matrix-org/synapse/downloads",
            "issues_url": "https://api.github.com/repos/matrix-org/synapse/issues{/number}",
            "pulls_url": "https://api.github.com/repos/matrix-org/synapse/pulls{/number}",
            "milestones_url": "https://api.github.com/repos/matrix-org/synapse/milestones{/number}",
            "notifications_url": "https://api.github.com/repos/matrix-org/synapse/notifications{?since,all,participating}",
            "labels_url": "https://api.github.com/repos/matrix-org/synapse/labels{/name}",
            "releases_url": "https://api.github.com/repos/matrix-org/synapse/releases{/id}",
            "deployments_url": "https://api.github.com/repos/matrix-org/synapse/deployments",
            "created_at": "2014-08-11T15:51:42Z",
            "updated_at": "2023-12-20T23:17:04Z",
            "pushed_at": "2023-12-14T07:12:07Z",
            "git_url": "git://github.com/matrix-org/synapse.git",
            "ssh_url": "git@github.com:matrix-org/synapse.git",
            "clone_url": "https://github.com/matrix-org/synapse.git",
            "svn_url": "https://github.com/matrix-org/synapse",
            "homepage": "https://matrix-org.github.io/synapse",
            "size": 431700,
            "stargazers_count": 11728,
            "watchers_count": 11728,
            "language": "Python",
            "has_issues": true,
            "has_projects": true,
            "has_downloads": true,
            "has_wiki": true,
            "has_pages": true,
            "has_discussions": false,
            "forks_count": 2195,
            "mirror_url": null,
            "archived": true,
            "disabled": false,
            "open_issues_count": 1518,
            "license": {
                "key": "apache-2.0",
                "name": "Apache License 2.0",
                "spdx_id": "Apache-2.0",
                "url": "https://api.github.com/licenses/apache-2.0",
                "node_id": "MDc6TGljZW5zZTI="
            },
            "allow_forking": true,
            "is_template": false,
            "web_commit_signoff_required": false,
            "topics": [
                "matrix-org",
                "python"
            ],
            "visibility": "public",
            "forks": 2195,
            "open_issues": 1518,
            "watchers": 11728,
            "default_branch": "develop"
        }
    },
    "_links": {
        "self": {
            "href": "https://api.github.com/repos/matrix-org/synapse/pulls/13723"
        },
        "html": {
            "href": "https://github.com/matrix-org/synapse/pull/13723"
        },
        "issue": {
            "href": "https://api.github.com/repos/matrix-org/synapse/issues/13723"
        },
        "comments": {
            "href": "https://api.github.com/repos/matrix-org/synapse/issues/13723/comments"
        },
        "review_comments": {
            "href": "https://api.github.com/repos/matrix-org/synapse/pulls/13723/comments"
        },
        "review_comment": {
            "href": "https://api.github.com/repos/matrix-org/synapse/pulls/comments{/number}"
        },
        "commits": {
            "href": "https://api.github.com/repos/matrix-org/synapse/pulls/13723/commits"
        },
        "statuses": {
            "href": "https://api.github.com/repos/matrix-org/synapse/statuses/be4c8ebc2f3dc2747b21647378e11569cc642f1e"
        }
    },
    "author_association": "CONTRIBUTOR",
    "auto_merge": null,
    "active_lock_reason": null,
    "merged": true,
    "mergeable": null,
    "rebaseable": null,
    "mergeable_state": "unknown",
    "merged_by": {
        "login": "squahtx",
        "id": 8349537,
        "node_id": "MDQ6VXNlcjgzNDk1Mzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8349537?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/squahtx",
        "html_url": "https://github.com/squahtx",
        "followers_url": "https://api.github.com/users/squahtx/followers",
        "following_url": "https://api.github.com/users/squahtx/following{/other_user}",
        "gists_url": "https://api.github.com/users/squahtx/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/squahtx/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/squahtx/subscriptions",
        "organizations_url": "https://api.github.com/users/squahtx/orgs",
        "repos_url": "https://api.github.com/users/squahtx/repos",
        "events_url": "https://api.github.com/users/squahtx/events{/privacy}",
        "received_events_url": "https://api.github.com/users/squahtx/received_events",
        "type": "User",
        "site_admin": false
    },
    "comments": 2,
    "review_comments": 0,
    "maintainer_can_modify": false,
    "commits": 5,
    "additions": 415,
    "deletions": 0,
    "changed_files": 3
}