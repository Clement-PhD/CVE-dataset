@@ -3,10 +3,14 @@
 
 use MediaWiki\Auth\TemporaryPasswordAuthenticationRequest;
 use MediaWiki\Auth\AuthManager;
+use MediaWiki\User\UserFactory;
 
 class SpecialScratchPasswordReset extends ScratchSpecialPage {
-	function __construct() {
-		parent::__construct('ScratchPasswordReset');
+	private AuthManager $authManager;
+
+	function __construct(UserFactory $userFactory, AuthManager $authManager) {
+		parent::__construct('ScratchPasswordReset', $userFactory);
+		$this->authManager = $authManager;
 	}
 
 	function getGroupName() {
@@ -16,7 +20,8 @@ function getGroupName() {
 	function showForm($out, $request) {
 		// show the verification form with pwreset instructions and "Verify" button
 		$this->verifForm(
-			$out, $request,
+			$out,
+			$request,
 			'passwordreset',
 			'scratchpasswordreset-verify'
 		);
@@ -25,7 +30,7 @@ function showForm($out, $request) {
 	function onPost($out, $request) {
 		// this shows errors if verif failed
 		$user = $this->verifSucceeded($out, $request);
-		if ($user == null) return;
+		if ($user === null) return;
 		// do the password reset, all has been checked
 		// create a new auth request to set a temporary password
 		$req = TemporaryPasswordAuthenticationRequest::newRandom();
@@ -34,7 +39,7 @@ function onPost($out, $request) {
 		// this needs to be set for changeAuthenticationData
 		$req->username = $user->getName();
 		// use the global AuthManager to submit the auth request
-		AuthManager::singleton()->changeAuthenticationData($req);
+		$this->authManager->changeAuthenticationData($req);
 		// display the password and pass the username to log in with
 		$out->addWikiMsg('scratchpasswordreset-success', $req->password, $user->getName());
 	}