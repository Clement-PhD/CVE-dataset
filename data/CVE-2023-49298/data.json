{
    "url": "https://api.github.com/repos/openzfs/zfs/pulls/15571",
    "id": 1615823070,
    "node_id": "PR_kwDOAAarE85gT4De",
    "html_url": "https://github.com/openzfs/zfs/pull/15571",
    "diff_url": "https://github.com/openzfs/zfs/pull/15571.diff",
    "patch_url": "https://github.com/openzfs/zfs/pull/15571.patch",
    "issue_url": "https://api.github.com/repos/openzfs/zfs/issues/15571",
    "number": 15571,
    "state": "closed",
    "locked": false,
    "title": "dnode_is_dirty: check dnode and its data for dirtiness",
    "user": {
        "login": "robn",
        "id": 130670,
        "node_id": "MDQ6VXNlcjEzMDY3MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/130670?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/robn",
        "html_url": "https://github.com/robn",
        "followers_url": "https://api.github.com/users/robn/followers",
        "following_url": "https://api.github.com/users/robn/following{/other_user}",
        "gists_url": "https://api.github.com/users/robn/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/robn/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/robn/subscriptions",
        "organizations_url": "https://api.github.com/users/robn/orgs",
        "repos_url": "https://api.github.com/users/robn/repos",
        "events_url": "https://api.github.com/users/robn/events{/privacy}",
        "received_events_url": "https://api.github.com/users/robn/received_events",
        "type": "User",
        "site_admin": false
    },
    "body": "### Motivation and Context\r\n\r\nCloses #15526.\r\n\r\n### Description\r\n\r\nOver its history this the dirty dnode test has been changed between checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and `dn_dirty_record`.\r\n\r\n  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency\r\n  2531ce372 Revert \"Report holes when there are only metadata changes\"\r\n  ec4f9b8f3 Report holes when there are only metadata changes\r\n  454365bba Fix dirty check in dmu_offset_next()\r\n  66aca2473 SEEK_HOLE should not block on txg_wait_synced()\r\n\r\nAlso illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9\r\n\r\nIt turns out both are actually required.\r\n\r\nIn the case of appending data to a newly created file, the dnode proper is dirtied (at least to change the blocksize) and dirty records are added.  Thus, a single logical operation is represented by separate dirty indicators, and must not be separated.\r\n\r\nThe incorrect dirty check becomes a problem when the first block of a file is being appended to while another process is calling lseek to skip holes. It can happen that the dnode part is undirtied, while dirty records are still on the dnode for the next txg. In this case, `lseek(fd, 0, SEEK_DATA)` would not know that the file is dirty, and would go to `dnode_next_offset()`. Since the object has no data blocks yet, it returns `ESRCH`, indicating no data found, which results in `ENXIO` being returned to `lseek()`'s caller.\r\n\r\nSince coreutils 9.2, `cp` performs sparse copies by default, that is, it uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to replicate the holes in the target. When it hits the bug, its initial search for data fails, and it goes on to call `fallocate()` to create a hole over the entire destination file.\r\n\r\nThis has come up more recently as users upgrade their systems, getting OpenZFS 2.2 as well as a newer coreutils. However, this problem has been reproduced against 2.1, as well as on FreeBSD 13 and 14.\r\n\r\nThis change simply updates the dirty check to check both types of dirty. If there's anything dirty at all, we immediately go to the \"wait for sync\" stage, It doesn't really matter after that; both changes are on disk, so the dirty fields should be correct.\r\n\r\n### How Has This Been Tested?\r\n\r\n@tonyhutter produced a repro script in #15526 which has been extremely useful. Its not perfect, but it can usually trip the issue in a couple of minutes. With the patch in place, no one has been able to trigger the issue. @rincebrain has been driving it reasonably hard (I think), no hits.\r\n\r\nFull test suite run has passed.\r\n\r\nI've done some general sanity and stress tests on customer workloads. They don't exercise the bug, but they all did fine, so this maybe hasn't broken anything.\r\n\r\nI'd like to write a test for this case, since its bitten a few times in the past, but it requires `lseek()` to be called after the dnode proper being undirtied but before the dbufs are undirtied. I don't have that kind of control from outside. Ideas welcome.\r\n\r\n### Types of changes\r\n\r\n- [x] Bug fix (non-breaking change which fixes an issue)\r\n- [ ] New feature (non-breaking change which adds functionality)\r\n- [ ] Performance enhancement (non-breaking change which improves efficiency)\r\n- [ ] Code cleanup (non-breaking change which makes code smaller or more readable)\r\n- [ ] Breaking change (fix or feature that would cause existing functionality to change)\r\n- [ ] Library ABI change (libzfs, libzfs\\_core, libnvpair, libuutil and libzfsbootenv)\r\n- [ ] Documentation (a change to man pages or other documentation)\r\n\r\n### Checklist:\r\n\r\n- [x] My code follows the OpenZFS [code style requirements](https://github.com/openzfs/zfs/blob/master/.github/CONTRIBUTING.md#coding-conventions).\r\n- [ ] I have updated the documentation accordingly.\r\n- [x] I have read the [**contributing** document](https://github.com/openzfs/zfs/blob/master/.github/CONTRIBUTING.md).\r\n- [ ] I have added [tests](https://github.com/openzfs/zfs/tree/master/tests) to cover my changes.\r\n- [x] I have run the ZFS Test Suite with this change applied.\r\n- [x] All commit messages are properly formatted and contain [`Signed-off-by`](https://github.com/openzfs/zfs/blob/master/.github/CONTRIBUTING.md#signed-off-by).",
    "created_at": "2023-11-24T13:49:47Z",
    "updated_at": "2023-12-01T10:01:12Z",
    "closed_at": "2023-11-28T17:07:57Z",
    "merged_at": "2023-11-28T17:07:57Z",
    "merge_commit_sha": "30d581121bb122c90959658e7b28b1672d342897",
    "assignee": null,
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "labels": [
        {
            "id": 1007099007,
            "node_id": "MDU6TGFiZWwxMDA3MDk5MDA3",
            "url": "https://api.github.com/repos/openzfs/zfs/labels/Status:%20Accepted",
            "name": "Status: Accepted",
            "color": "00b33c",
            "default": false,
            "description": "Ready to integrate (reviewed, tested)"
        }
    ],
    "milestone": null,
    "draft": false,
    "commits_url": "https://api.github.com/repos/openzfs/zfs/pulls/15571/commits",
    "review_comments_url": "https://api.github.com/repos/openzfs/zfs/pulls/15571/comments",
    "review_comment_url": "https://api.github.com/repos/openzfs/zfs/pulls/comments{/number}",
    "comments_url": "https://api.github.com/repos/openzfs/zfs/issues/15571/comments",
    "statuses_url": "https://api.github.com/repos/openzfs/zfs/statuses/c7fadf230f26be750feddaebda95e5cc66896107",
    "head": {
        "label": "robn:dnode-dirty-data",
        "ref": "dnode-dirty-data",
        "sha": "c7fadf230f26be750feddaebda95e5cc66896107",
        "user": {
            "login": "robn",
            "id": 130670,
            "node_id": "MDQ6VXNlcjEzMDY3MA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/130670?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/robn",
            "html_url": "https://github.com/robn",
            "followers_url": "https://api.github.com/users/robn/followers",
            "following_url": "https://api.github.com/users/robn/following{/other_user}",
            "gists_url": "https://api.github.com/users/robn/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/robn/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/robn/subscriptions",
            "organizations_url": "https://api.github.com/users/robn/orgs",
            "repos_url": "https://api.github.com/users/robn/repos",
            "events_url": "https://api.github.com/users/robn/events{/privacy}",
            "received_events_url": "https://api.github.com/users/robn/received_events",
            "type": "User",
            "site_admin": false
        },
        "repo": {
            "id": 356735295,
            "node_id": "MDEwOlJlcG9zaXRvcnkzNTY3MzUyOTU=",
            "name": "zfs",
            "full_name": "robn/zfs",
            "private": false,
            "owner": {
                "login": "robn",
                "id": 130670,
                "node_id": "MDQ6VXNlcjEzMDY3MA==",
                "avatar_url": "https://avatars.githubusercontent.com/u/130670?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/robn",
                "html_url": "https://github.com/robn",
                "followers_url": "https://api.github.com/users/robn/followers",
                "following_url": "https://api.github.com/users/robn/following{/other_user}",
                "gists_url": "https://api.github.com/users/robn/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/robn/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robn/subscriptions",
                "organizations_url": "https://api.github.com/users/robn/orgs",
                "repos_url": "https://api.github.com/users/robn/repos",
                "events_url": "https://api.github.com/users/robn/events{/privacy}",
                "received_events_url": "https://api.github.com/users/robn/received_events",
                "type": "User",
                "site_admin": false
            },
            "html_url": "https://github.com/robn/zfs",
            "description": "OpenZFS on Linux and FreeBSD",
            "fork": true,
            "url": "https://api.github.com/repos/robn/zfs",
            "forks_url": "https://api.github.com/repos/robn/zfs/forks",
            "keys_url": "https://api.github.com/repos/robn/zfs/keys{/key_id}",
            "collaborators_url": "https://api.github.com/repos/robn/zfs/collaborators{/collaborator}",
            "teams_url": "https://api.github.com/repos/robn/zfs/teams",
            "hooks_url": "https://api.github.com/repos/robn/zfs/hooks",
            "issue_events_url": "https://api.github.com/repos/robn/zfs/issues/events{/number}",
            "events_url": "https://api.github.com/repos/robn/zfs/events",
            "assignees_url": "https://api.github.com/repos/robn/zfs/assignees{/user}",
            "branches_url": "https://api.github.com/repos/robn/zfs/branches{/branch}",
            "tags_url": "https://api.github.com/repos/robn/zfs/tags",
            "blobs_url": "https://api.github.com/repos/robn/zfs/git/blobs{/sha}",
            "git_tags_url": "https://api.github.com/repos/robn/zfs/git/tags{/sha}",
            "git_refs_url": "https://api.github.com/repos/robn/zfs/git/refs{/sha}",
            "trees_url": "https://api.github.com/repos/robn/zfs/git/trees{/sha}",
            "statuses_url": "https://api.github.com/repos/robn/zfs/statuses/{sha}",
            "languages_url": "https://api.github.com/repos/robn/zfs/languages",
            "stargazers_url": "https://api.github.com/repos/robn/zfs/stargazers",
            "contributors_url": "https://api.github.com/repos/robn/zfs/contributors",
            "subscribers_url": "https://api.github.com/repos/robn/zfs/subscribers",
            "subscription_url": "https://api.github.com/repos/robn/zfs/subscription",
            "commits_url": "https://api.github.com/repos/robn/zfs/commits{/sha}",
            "git_commits_url": "https://api.github.com/repos/robn/zfs/git/commits{/sha}",
            "comments_url": "https://api.github.com/repos/robn/zfs/comments{/number}",
            "issue_comment_url": "https://api.github.com/repos/robn/zfs/issues/comments{/number}",
            "contents_url": "https://api.github.com/repos/robn/zfs/contents/{+path}",
            "compare_url": "https://api.github.com/repos/robn/zfs/compare/{base}...{head}",
            "merges_url": "https://api.github.com/repos/robn/zfs/merges",
            "archive_url": "https://api.github.com/repos/robn/zfs/{archive_format}{/ref}",
            "downloads_url": "https://api.github.com/repos/robn/zfs/downloads",
            "issues_url": "https://api.github.com/repos/robn/zfs/issues{/number}",
            "pulls_url": "https://api.github.com/repos/robn/zfs/pulls{/number}",
            "milestones_url": "https://api.github.com/repos/robn/zfs/milestones{/number}",
            "notifications_url": "https://api.github.com/repos/robn/zfs/notifications{?since,all,participating}",
            "labels_url": "https://api.github.com/repos/robn/zfs/labels{/name}",
            "releases_url": "https://api.github.com/repos/robn/zfs/releases{/id}",
            "deployments_url": "https://api.github.com/repos/robn/zfs/deployments",
            "created_at": "2021-04-11T01:02:32Z",
            "updated_at": "2023-03-19T01:29:30Z",
            "pushed_at": "2023-12-21T02:55:27Z",
            "git_url": "git://github.com/robn/zfs.git",
            "ssh_url": "git@github.com:robn/zfs.git",
            "clone_url": "https://github.com/robn/zfs.git",
            "svn_url": "https://github.com/robn/zfs",
            "homepage": "https://openzfs.github.io/openzfs-docs",
            "size": 127034,
            "stargazers_count": 0,
            "watchers_count": 0,
            "language": "C",
            "has_issues": true,
            "has_projects": false,
            "has_downloads": true,
            "has_wiki": false,
            "has_pages": false,
            "has_discussions": false,
            "forks_count": 0,
            "mirror_url": null,
            "archived": false,
            "disabled": false,
            "open_issues_count": 0,
            "license": {
                "key": "other",
                "name": "Other",
                "spdx_id": "NOASSERTION",
                "url": null,
                "node_id": "MDc6TGljZW5zZTA="
            },
            "allow_forking": true,
            "is_template": false,
            "web_commit_signoff_required": false,
            "topics": [],
            "visibility": "public",
            "forks": 0,
            "open_issues": 0,
            "watchers": 0,
            "default_branch": "master"
        }
    },
    "base": {
        "label": "openzfs:master",
        "ref": "master",
        "sha": "126efb588969134922171fa32e123ddb1ccac2f2",
        "user": {
            "login": "openzfs",
            "id": 4510897,
            "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ1MTA4OTc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/4510897?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/openzfs",
            "html_url": "https://github.com/openzfs",
            "followers_url": "https://api.github.com/users/openzfs/followers",
            "following_url": "https://api.github.com/users/openzfs/following{/other_user}",
            "gists_url": "https://api.github.com/users/openzfs/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/openzfs/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/openzfs/subscriptions",
            "organizations_url": "https://api.github.com/users/openzfs/orgs",
            "repos_url": "https://api.github.com/users/openzfs/repos",
            "events_url": "https://api.github.com/users/openzfs/events{/privacy}",
            "received_events_url": "https://api.github.com/users/openzfs/received_events",
            "type": "Organization",
            "site_admin": false
        },
        "repo": {
            "id": 437011,
            "node_id": "MDEwOlJlcG9zaXRvcnk0MzcwMTE=",
            "name": "zfs",
            "full_name": "openzfs/zfs",
            "private": false,
            "owner": {
                "login": "openzfs",
                "id": 4510897,
                "node_id": "MDEyOk9yZ2FuaXphdGlvbjQ1MTA4OTc=",
                "avatar_url": "https://avatars.githubusercontent.com/u/4510897?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/openzfs",
                "html_url": "https://github.com/openzfs",
                "followers_url": "https://api.github.com/users/openzfs/followers",
                "following_url": "https://api.github.com/users/openzfs/following{/other_user}",
                "gists_url": "https://api.github.com/users/openzfs/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/openzfs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/openzfs/subscriptions",
                "organizations_url": "https://api.github.com/users/openzfs/orgs",
                "repos_url": "https://api.github.com/users/openzfs/repos",
                "events_url": "https://api.github.com/users/openzfs/events{/privacy}",
                "received_events_url": "https://api.github.com/users/openzfs/received_events",
                "type": "Organization",
                "site_admin": false
            },
            "html_url": "https://github.com/openzfs/zfs",
            "description": "OpenZFS on Linux and FreeBSD",
            "fork": false,
            "url": "https://api.github.com/repos/openzfs/zfs",
            "forks_url": "https://api.github.com/repos/openzfs/zfs/forks",
            "keys_url": "https://api.github.com/repos/openzfs/zfs/keys{/key_id}",
            "collaborators_url": "https://api.github.com/repos/openzfs/zfs/collaborators{/collaborator}",
            "teams_url": "https://api.github.com/repos/openzfs/zfs/teams",
            "hooks_url": "https://api.github.com/repos/openzfs/zfs/hooks",
            "issue_events_url": "https://api.github.com/repos/openzfs/zfs/issues/events{/number}",
            "events_url": "https://api.github.com/repos/openzfs/zfs/events",
            "assignees_url": "https://api.github.com/repos/openzfs/zfs/assignees{/user}",
            "branches_url": "https://api.github.com/repos/openzfs/zfs/branches{/branch}",
            "tags_url": "https://api.github.com/repos/openzfs/zfs/tags",
            "blobs_url": "https://api.github.com/repos/openzfs/zfs/git/blobs{/sha}",
            "git_tags_url": "https://api.github.com/repos/openzfs/zfs/git/tags{/sha}",
            "git_refs_url": "https://api.github.com/repos/openzfs/zfs/git/refs{/sha}",
            "trees_url": "https://api.github.com/repos/openzfs/zfs/git/trees{/sha}",
            "statuses_url": "https://api.github.com/repos/openzfs/zfs/statuses/{sha}",
            "languages_url": "https://api.github.com/repos/openzfs/zfs/languages",
            "stargazers_url": "https://api.github.com/repos/openzfs/zfs/stargazers",
            "contributors_url": "https://api.github.com/repos/openzfs/zfs/contributors",
            "subscribers_url": "https://api.github.com/repos/openzfs/zfs/subscribers",
            "subscription_url": "https://api.github.com/repos/openzfs/zfs/subscription",
            "commits_url": "https://api.github.com/repos/openzfs/zfs/commits{/sha}",
            "git_commits_url": "https://api.github.com/repos/openzfs/zfs/git/commits{/sha}",
            "comments_url": "https://api.github.com/repos/openzfs/zfs/comments{/number}",
            "issue_comment_url": "https://api.github.com/repos/openzfs/zfs/issues/comments{/number}",
            "contents_url": "https://api.github.com/repos/openzfs/zfs/contents/{+path}",
            "compare_url": "https://api.github.com/repos/openzfs/zfs/compare/{base}...{head}",
            "merges_url": "https://api.github.com/repos/openzfs/zfs/merges",
            "archive_url": "https://api.github.com/repos/openzfs/zfs/{archive_format}{/ref}",
            "downloads_url": "https://api.github.com/repos/openzfs/zfs/downloads",
            "issues_url": "https://api.github.com/repos/openzfs/zfs/issues{/number}",
            "pulls_url": "https://api.github.com/repos/openzfs/zfs/pulls{/number}",
            "milestones_url": "https://api.github.com/repos/openzfs/zfs/milestones{/number}",
            "notifications_url": "https://api.github.com/repos/openzfs/zfs/notifications{?since,all,participating}",
            "labels_url": "https://api.github.com/repos/openzfs/zfs/labels{/name}",
            "releases_url": "https://api.github.com/repos/openzfs/zfs/releases{/id}",
            "deployments_url": "https://api.github.com/repos/openzfs/zfs/deployments",
            "created_at": "2009-12-14T20:20:34Z",
            "updated_at": "2023-12-21T06:26:51Z",
            "pushed_at": "2023-12-21T02:55:30Z",
            "git_url": "git://github.com/openzfs/zfs.git",
            "ssh_url": "git@github.com:openzfs/zfs.git",
            "clone_url": "https://github.com/openzfs/zfs.git",
            "svn_url": "https://github.com/openzfs/zfs",
            "homepage": "https://openzfs.github.io/openzfs-docs",
            "size": 126139,
            "stargazers_count": 9815,
            "watchers_count": 9815,
            "language": "C",
            "has_issues": true,
            "has_projects": true,
            "has_downloads": true,
            "has_wiki": true,
            "has_pages": false,
            "has_discussions": true,
            "forks_count": 1696,
            "mirror_url": null,
            "archived": false,
            "disabled": false,
            "open_issues_count": 1255,
            "license": {
                "key": "other",
                "name": "Other",
                "spdx_id": "NOASSERTION",
                "url": null,
                "node_id": "MDc6TGljZW5zZTA="
            },
            "allow_forking": true,
            "is_template": false,
            "web_commit_signoff_required": true,
            "topics": [
                "file-system",
                "openzfs",
                "system-software"
            ],
            "visibility": "public",
            "forks": 1696,
            "open_issues": 1255,
            "watchers": 9815,
            "default_branch": "master"
        }
    },
    "_links": {
        "self": {
            "href": "https://api.github.com/repos/openzfs/zfs/pulls/15571"
        },
        "html": {
            "href": "https://github.com/openzfs/zfs/pull/15571"
        },
        "issue": {
            "href": "https://api.github.com/repos/openzfs/zfs/issues/15571"
        },
        "comments": {
            "href": "https://api.github.com/repos/openzfs/zfs/issues/15571/comments"
        },
        "review_comments": {
            "href": "https://api.github.com/repos/openzfs/zfs/pulls/15571/comments"
        },
        "review_comment": {
            "href": "https://api.github.com/repos/openzfs/zfs/pulls/comments{/number}"
        },
        "commits": {
            "href": "https://api.github.com/repos/openzfs/zfs/pulls/15571/commits"
        },
        "statuses": {
            "href": "https://api.github.com/repos/openzfs/zfs/statuses/c7fadf230f26be750feddaebda95e5cc66896107"
        }
    },
    "author_association": "CONTRIBUTOR",
    "auto_merge": null,
    "active_lock_reason": null,
    "merged": true,
    "mergeable": null,
    "rebaseable": null,
    "mergeable_state": "unknown",
    "merged_by": {
        "login": "behlendorf",
        "id": 148917,
        "node_id": "MDQ6VXNlcjE0ODkxNw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/148917?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/behlendorf",
        "html_url": "https://github.com/behlendorf",
        "followers_url": "https://api.github.com/users/behlendorf/followers",
        "following_url": "https://api.github.com/users/behlendorf/following{/other_user}",
        "gists_url": "https://api.github.com/users/behlendorf/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/behlendorf/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/behlendorf/subscriptions",
        "organizations_url": "https://api.github.com/users/behlendorf/orgs",
        "repos_url": "https://api.github.com/users/behlendorf/repos",
        "events_url": "https://api.github.com/users/behlendorf/events{/privacy}",
        "received_events_url": "https://api.github.com/users/behlendorf/received_events",
        "type": "User",
        "site_admin": false
    },
    "comments": 19,
    "review_comments": 21,
    "maintainer_can_modify": false,
    "commits": 1,
    "additions": 10,
    "deletions": 2,
    "changed_files": 1
}