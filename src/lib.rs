use std::path::Path;

use cve_commit::cve_metadata::CveMetadata;
use cve_commit::CveCommit;


pub mod cve_commit;
pub mod patch;
pub mod language;
mod params;

/// Load all cves data from a folder containing cve data
pub fn load_from_folder<P: AsRef<Path>>(folder_path: P) -> Vec<CveCommit> {
    let mut cve_commits : Vec<CveCommit> = vec![];

    for entry in folder_path.as_ref().read_dir().unwrap() {
        if let Ok(entry) = entry {

            if let Ok(file_type) = entry.file_type() {
                if file_type.is_dir() {
                    let cve_data_folder = entry.path();
                    let cve_id = cve_data_folder.file_name().unwrap().to_str().unwrap();
                    let cve_commit = CveCommit::new(cve_id, &cve_data_folder);
                    cve_commits.push(cve_commit);
                }
                
            }
        }
    }

    cve_commits
}

/// load all metadata from the data folder (skip cve who cannot be parsed)
pub fn load_cve_metadata_from_folder<P: AsRef<Path>>(folder_path: P) -> Vec<CveMetadata> {
    let mut cve_metadatas : Vec<CveMetadata> = vec![];
    let folder_path = folder_path.as_ref();

    for entry in folder_path.read_dir().unwrap() {
        if let Ok(entry) = entry {
            if let Ok(file_type) = entry.file_type() {
                if file_type.is_dir() {
                    let cve_data_folder = entry.path();
                    let cve_metadata_option = CveMetadata::from_cve_folder(&cve_data_folder).unwrap();
                    if let Some(cve_metadata) = cve_metadata_option {
                        cve_metadatas.push(cve_metadata);
                    }
                }
            }
        }
    }

    cve_metadatas
}

/// Load all cves metadata from the data folder (inside the binary)
#[cfg(feature = "include-data")]
pub fn load_cve_metadata() -> Vec<CveMetadata> {
    load_cve_metadata_from_folder("data/")
}

/// Load all cves data from the data folder (inside the binary)
#[cfg(feature = "include-data")]
pub fn load_cve_data() -> Vec<CveCommit> {
    load_from_folder("data/")
}

